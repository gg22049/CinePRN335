<?xml version="1.0" encoding="UTF-8"?>

<f:composition xmlns="http://www.w3.org/1999/xhtml"
               xmlns:p="http://primefaces.org/ui"
               xmlns:h="jakarta.faces.html"
               xmlns:f="jakarta.faces.facelets"
               template="WEB-INF/templates/principal.xhtml"
               xmlns:c="jakarta.faces.core"
               xmlns:crud="jakarta.faces.composite/crud"
               xmlns:datos="jakarta.faces.composite/datos">

    <f:define name="titulo">
        #{frmReserva.titulo}
    </f:define>

    <f:define name="cuerpo">

        <h:form id="reservaFrm">

            <p:growl id="growl" sticky="true" showDetail="true"/>

            <p:wizard id="reservaWizard" flowListener="#{reservaWizardBean.onFlowProcess}" widgetVar="wizard">

                <!-- Paso 1: Fecha y Tipo de Reserva, formato de fecha offsetDataTime no compatible con primefaces -->
                <p:tab id="fechaStep" title="Fecha">
                    <p:panel header="Seleccionar Fecha">
                        <p:messages/>
                        <h:panelGrid columns="2">
                            <h:outputText value="Seleccione día: *"/>
                            <p:calendar value="#{reservaWizardBean.fechaReservaSeleccionada}"
                                        label="Seleccione un día" required="true"
                                        requiredMessage="Seleccione una fecha válida"
                                        pattern="yyyy-MM-dd" showButtonPanel="true"
                                        mindate="#{reservaWizardBean.fechaReservaMinima}"/>
                            <h:outputText value="Tipo de Reserva: *"/>
                            <p:selectOneMenu id="tipoReservaOption"
                                             value="#{reservaWizardBean.idTipoReservaSeleccionado}"
                                             required="" requiredMessage="Seleccione un Tipo de Reserva válido">
                                <c:selectItems value="#{frmReserva.tiposReserva}"
                                               var="tr"
                                               itemLabel="#{tr.nombre}"
                                               itemValue="#{tr.idTipoReserva}"/>
                            </p:selectOneMenu>
                        </h:panelGrid>
                    </p:panel>
                </p:tab>

                <!-- Paso 2: Seleccionar una programción -->
                <p:tab id="funcionStep" title="Función">
                    <p:panel header="Seleccionar Función">
                        <p:messages/>
                        <h:panelGrid columns="1">
                            <h:outputText value="Seleccione función disponible: " style="display: block; margin-bottom: 15px;"/>
                            <p:selectOneMenu id="programacionOption"
                                             value="#{reservaWizardBean.idProgramacionSeleccionada}"
                                             style="display: block; margin-bottom: 15px;">
                                <c:selectItem itemValue="#{null}" itemLabel="Seleccione una opción"/>
                                <c:selectItems value="#{frmProgramacion.programacionesDelDia}" var="prn"
                                               itemLabel="#{prn.idPelicula.nombre}, #{prn.idSala.nombre}, #{prn.idSala.idSucursal.nombre}, (#{prn.desde} - #{prn.hasta})"
                                               itemValue="#{prn.idProgramacion}"/>
                                <!-- Ajax para actualizar cuando se cambia la selección -->
                                <p:ajax event="change" update="outputSinopsisText"/>
                                <p:ajax event="change" update="outputSinopsisValue"/>
                                <p:ajax event="change" update="outCaracterísticas"/>

                            </p:selectOneMenu>
                        </h:panelGrid>
                        <h:outputText id="outputSinopsisText" style="display: block; margin-bottom: 15px;  font-weight:bold"
                                      value="#{reservaWizardBean.idProgramacionSeleccionada == null ? '' : 'Sinopsis'}"/>
                        <h:outputText id="outputSinopsisValue" style="display: block; margin-bottom: 15px;"
                                      value="#{reservaWizardBean.idProgramacionSeleccionada == null ? '' : frmProgramacion.dataPersist.findById(reservaWizardBean.idProgramacionSeleccionada).idPelicula.sinopsis}"/>
                        <h:outputText id="outCaracterísticas" style="display: block; margin-bottom: 15px;  font-weight:bold"
                                      value="#{reservaWizardBean.idProgramacionSeleccionada == null ? '' : 'Características'}"/>
                    </p:panel>
                </p:tab>


                <p:tab id="asientoStep" title="Asientos">
                    <p:panel header="Asientos">
                        <p:messages/>
                        <p:pickList value="#{reservaWizardBean.asientoDualListModel}"
                                    var="asiento" immediate="false"
                                    itemLabel="Asiento # #{asiento}"
                                    filter="true" filterMatchMode="contains"
                                    itemValue="#{asiento}"
                                    showCheckbox="true" transferOnCheckboxClick="true"
                                    showSourceControls="false" showTargetControls="false"
                                    rendered="#{not empty reservaWizardBean.asientoDualListModel.source}"
                                    >
                        </p:pickList>
                    </p:panel>
                </p:tab>

                <p:tab id="confirmacionStep" title="Confirmar">
                    <p:panel header="Confirmar Reserva">
                        <p:messages/>
                        <h:panelGrid id="confirmation" columns="2">
                            <h:outputText value="Pelicula: #{frmReserva.registro.idProgramacion.idPelicula.nombre}"
                                          style="margin-bottom: 15px;"/>
                            <h:outputText value="Hora: #{frmReserva.registro.idProgramacion.desde} #{frmReserva.registro.idProgramacion.hasta}"
                                          style="margin-bottom: 15px;"/>
                            <h:outputText value="Asientos: " style="margin-bottom: 15px;"/>
                            <p:selectOneMenu>
                                <c:selectItems value="#{reservaWizardBean.asientoDualListModel.target}" var="asiento" itemLabel="Asiento ##{asiento}"/>
                            </p:selectOneMenu>
                        </h:panelGrid>

                        <p:commandButton value="Confirmar Reserva" action="#{reservaWizardBean.save}" update="growl" process="@form"/>
                    </p:panel>
                </p:tab>
            </p:wizard>
        </h:form>
    </f:define>


</f:composition>